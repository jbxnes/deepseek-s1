#!/bin/bash
#SBATCH -p a40
#SBATCH --gres gpu:1
#SBATCH -c 8
#SBATCH --mem 32GB
#SBATCH --time 5:00:00
#SBATCH --job-name vllm-trl
#SBATCH --output=logs/grpo_%A.out
#SBATCH --error=logs/grpo_%A.err

module load singularity-ce

SIF_PATH=/projects/llm/unsloth-vllm-trl-latest.sif

# Initialize overlay virtual environment on top of system packages from SIF
# This .venv is empty (~27KB) by default.
# To install new packages, modify pyproject.toml. See README.md FAQ for more details.
singularity exec \
    ${SIF_PATH} \
    uv venv --system-site-packages .venv

singularity exec \
--nv \
--bind /model-weights:/model-weights \
--bind /projects/llm:/projects/llm \
--bind /scratch/ssd004/scratch/`whoami`:/scratch \
--bind /opt/slurm/:/opt/slurm/ \
${SIF_PATH} \
uv run grpo/train.py \
    --model_name /model-weights/Qwen2.5-3B-Instruct \
    --lora_rank 64 \
    --num_examples -1 \
    --per_device_train_batch_size 8 \
    --gradient_accumulation_steps 1 \
    --max_completion_length 1024 \
    --num_generations 8 \
    --num_steps 250 \
    # --format_reward \
    # --do_budget_forcing \
    # --min_budget 256 \
